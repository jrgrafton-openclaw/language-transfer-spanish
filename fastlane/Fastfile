default_platform(:ios)

platform :ios do
  before_all do
    setup_ci if ENV['CI']
  end

  desc "Get App Store Connect API key"
  private_lane :api_key do
    app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_KEY_ID'] || "7UKLD4C2CC",
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'] || "69a6de70-79a7-47e3-e053-5b8c7c11a4d1",
      key_filepath: ENV['APP_STORE_CONNECT_API_KEY_PATH'],
      in_house: false
    )
  end

  desc "Create app in App Store Connect and Developer Portal"
  lane :create_app do
    api_key

    produce(
      app_identifier: "com.grafton.languagetransfer.spanish",
      app_name: "Language Transfer - Spanish",
      language: "English",
      sku: "com.grafton.languagetransfer.spanish",
      platforms: ["ios"]
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    api_key

    # Increment build number
    increment_build_number(xcodeproj: "LanguageTransfer.xcodeproj")

    build_number = get_build_number(xcodeproj: "LanguageTransfer.xcodeproj")
    version_number = get_version_number(xcodeproj: "LanguageTransfer.xcodeproj", target: "LanguageTransfer")

    archive_path = File.expand_path("../build/LanguageTransfer.xcarchive", __dir__)
    ipa_dir = File.expand_path("../build", __dir__)
    ipa_path = File.expand_path("../build/LanguageTransfer.ipa", __dir__)
    export_options_path = File.expand_path("../ExportOptions.plist", __dir__)

    # Write export options plist
    File.write(export_options_path, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store</string>
        <key>teamID</key>
        <string>B5X96QDRF4</string>
        <key>uploadSymbols</key>
        <true/>
        <key>compileBitcode</key>
        <false/>
        <key>signingStyle</key>
        <string>automatic</string>
      </dict>
      </plist>
    PLIST

    # Build archive directly (bypasses gym's showBuildSettings timeout issue)
    sh %Q{
      set -e
      cd /Users/familybot/.openclaw/workspace/language-transfer-spanish
      mkdir -p build
      xcodebuild \
        -project LanguageTransfer.xcodeproj \
        -scheme LanguageTransfer \
        -destination 'generic/platform=iOS' \
        -archivePath '#{archive_path}' \
        -allowProvisioningUpdates \
        clean archive \
        2>&1 | tail -20
    }

    # Export IPA from archive
    sh %Q{
      set -e
      xcodebuild \
        -exportArchive \
        -archivePath '#{archive_path}' \
        -exportOptionsPlist '#{export_options_path}' \
        -exportPath '#{ipa_dir}' \
        -allowProvisioningUpdates \
        2>&1 | tail -10
    }

    # Upload to TestFlight
    sh %Q{
      KEY_FILE="${APP_STORE_CONNECT_API_KEY_PATH:?APP_STORE_CONNECT_API_KEY_PATH is required}"
      KEY_ID="${APP_STORE_CONNECT_KEY_ID:-7UKLD4C2CC}"
      ISSUER_ID="${APP_STORE_CONNECT_ISSUER_ID:-69a6de70-79a7-47e3-e053-5b8c7c11a4d1}"
      KEY_CONTENT=$(cat "$KEY_FILE")
      cat > /tmp/asc_api_key.json << EOF
{
  "key_id": "$KEY_ID",
  "issuer_id": "$ISSUER_ID",
  "key": $(echo "$KEY_CONTENT" | jq -Rs .),
  "duration": 1200,
  "in_house": false
}
EOF

      fastlane pilot upload --ipa "#{ipa_path}" \
        --skip_waiting_for_build_processing \
        --api-key-path /tmp/asc_api_key.json
    }

    # Tag the build
    add_git_tag(tag: "v#{version_number}-build#{build_number}")
    push_git_tags

    # Commit version bump
    git_commit(
      path: ["LanguageTransfer.xcodeproj/project.pbxproj", "LanguageTransfer/Info.plist"],
      message: "[ci skip] Bump build to #{build_number}"
    )
    push_to_git_remote
  end

  desc "Build only (no upload)"
  lane :build_only do
    archive_path = File.expand_path("../build/LanguageTransfer.xcarchive", __dir__)
    ipa_dir = File.expand_path("../build", __dir__)
    export_options_path = File.expand_path("../ExportOptions.plist", __dir__)

    File.write(export_options_path, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store</string>
        <key>teamID</key>
        <string>B5X96QDRF4</string>
        <key>uploadSymbols</key>
        <true/>
        <key>compileBitcode</key>
        <false/>
        <key>signingStyle</key>
        <string>automatic</string>
      </dict>
      </plist>
    PLIST

    sh %Q{
      set -e
      cd /Users/familybot/.openclaw/workspace/language-transfer-spanish
      mkdir -p build
      xcodebuild \
        -project LanguageTransfer.xcodeproj \
        -scheme LanguageTransfer \
        -destination 'generic/platform=iOS' \
        -archivePath '#{archive_path}' \
        -allowProvisioningUpdates \
        clean archive \
        2>&1 | tail -20
    }

    sh %Q{
      set -e
      xcodebuild \
        -exportArchive \
        -archivePath '#{archive_path}' \
        -exportOptionsPlist '#{export_options_path}' \
        -exportPath '#{ipa_dir}' \
        -allowProvisioningUpdates \
        2>&1 | tail -10
    }
  end

  desc "Upload dSYMs to Firebase Crashlytics"
  lane :upload_symbols do
    upload_symbols_to_crashlytics(
      gsp_path: "./LanguageTransfer/GoogleService-Info.plist"
    )
  end
end
