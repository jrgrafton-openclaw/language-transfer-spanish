default_platform(:ios)

platform :ios do
  before_all do
    setup_ci if ENV['CI']
  end

  desc "Get App Store Connect API key"
  private_lane :api_key do
    app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_KEY_ID'] || "7UKLD4C2CC",
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'] || "69a6de70-79a7-47e3-e053-5b8c7c11a4d1",
      key_filepath: ENV['APP_STORE_CONNECT_API_KEY_PATH'] || "$ASC_KEY_PATH",
      in_house: false
    )
  end

  desc "Create app in App Store Connect and Developer Portal"
  lane :create_app do
    api_key

    produce(
      app_identifier: "com.grafton.languagetransfer.spanish",
      app_name: "Language Transfer - Spanish",
      language: "English",
      sku: "com.grafton.languagetransfer.spanish",
      platforms: ["ios"]
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    api_key

    # Increment build number
    increment_build_number(xcodeproj: "LanguageTransfer.xcodeproj")

    # Build the app
    build_app(
      project: "LanguageTransfer.xcodeproj",
      scheme: "LanguageTransfer",
      export_method: "app-store",
      clean: true,
      output_directory: "./build",
      output_name: "LanguageTransfer.ipa"
    )

    # Upload to TestFlight (manual method to workaround fastlane JSON parsing bug)
    sh %Q{
      KEY_CONTENT=$(cat $ASC_KEY_PATH)
      cat > /tmp/asc_api_key.json << EOF
{
  "key_id": "7UKLD4C2CC",
  "issuer_id": "69a6de70-79a7-47e3-e053-5b8c7c11a4d1",
  "key": $(echo "$KEY_CONTENT" | jq -Rs .),
  "duration": 1200,
  "in_house": false
}
EOF
      
      fastlane pilot upload --ipa ./build/LanguageTransfer.ipa \
        --skip_waiting_for_build_processing \
        --api-key-path /tmp/asc_api_key.json
    }

    # Get version info
    build_number = get_build_number(xcodeproj: "LanguageTransfer.xcodeproj")
    version_number = get_version_number(xcodeproj: "LanguageTransfer.xcodeproj", target: "LanguageTransfer")

    # Tag the build
    add_git_tag(tag: "v#{version_number}-build#{build_number}")
    push_git_tags

    # Commit version bump
    git_commit(
      path: ["LanguageTransfer.xcodeproj/project.pbxproj"],
      message: "[ci skip] Bump build to #{build_number}"
    )
    push_to_git_remote
  end

  desc "Build only (no upload)"
  lane :build_only do
    build_app(
      project: "LanguageTransfer.xcodeproj",
      scheme: "LanguageTransfer",
      export_method: "app-store",
      clean: true,
      output_directory: "./build",
      output_name: "LanguageTransfer.ipa"
    )
  end

  desc "Upload dSYMs to Firebase Crashlytics"
  lane :upload_symbols do
    upload_symbols_to_crashlytics(
      gsp_path: "./LanguageTransfer/GoogleService-Info.plist"
    )
  end
end
